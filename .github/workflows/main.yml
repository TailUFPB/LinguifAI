# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: CI
# Controls when the workflow will run
on:
  push:
    branches: [ "main" ]
  pull_request:
    types: [opened, synchronize]

# Prevent duplicate workflows from running
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
    # Static tests don't involve any logic or context.
    # They are just a set of tests that can detect if we are not introducing any faulty code.
    static-test:
      name: ğŸ”¬ Static tests
      runs-on: ubuntu-latest
      steps:
        - name: â¬‡ï¸ Checkout repo
          uses: actions/checkout@v4
          with:
            fetch-depth: 2
  
        - name: â” Setup node
          uses: actions/setup-node@v3
          with:
            cache: 'npm'
  
        - name: ğŸ“¦ Install dependencies
          run: npm install
  
    # Unit tests are tests that are not dependent on any external service.
    # Usually, they are tests that are testing the logic of a specific function or component.
    unit-test:
      needs: [static-test]
      name: ğŸš¦ Unit tests
      runs-on: ubuntu-latest
      steps:
        - name: â¬‡ï¸ Checkout repo
          uses: actions/checkout@v4
          with:
            fetch-depth: 2
  
        - name: â” Setup node
          uses: actions/setup-node@v3
          with:
            cache: 'npm'
  
        - name: ğŸ“¦ Install dependencies
          run: npm install
  
        - name: ğŸš¦ Run unit tests
          run: npm test
  
    # Integration tests are tests that are dependent on external services.
    integration-test:
      needs: [static-test]
      name: ğŸš¥ Integration tests
      runs-on: ubuntu-latest
      steps:
        - name: â¬‡ï¸ Checkout repo
          uses: actions/checkout@v4
          with:
            fetch-depth: 2
  
        - name: â” Setup node
          uses: actions/setup-node@v3
          with:
            cache: 'npm'
  
        - name: ğŸ“¦ Install dependencies
          run: npm install
  
        # - name: ğŸ³ Docker compose
        #   run:
        #     docker-compose up -d && sleep 3 && pnpm prisma migrate reset --force
        #     --skip-seed
  
        - name: ğŸš¦ Run integration tests
          run: npm test
